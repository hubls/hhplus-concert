# 🚀대기열 시스템 Mysql에서 Redis로 이관

## 1. 기존 방식(Mysql을 통한 관리)
- 현재 대기열 관련하여 RDB를 사용중이며, 토큰을 발급해서 RDB에 저장 후 확인하는 방식을 사용중에 있습니다.

### 1. 대기열 토큰 생성(`POST /api/v1/queue/tokens`)
   1. 사용자가 대기열 토큰 생성 요청을 보낸다.
   2. `RDB`에서 활성화 된 토큰수를 확인 후에 `대기` 혹은 `활성`토큰 발급한다.


### 2. 대기열 토큰 상태 조회(`GET /api/v1/queue/status`)
   1. 사용자가 현재 자신의 토큰 상태 조회 요청을 보낸다.
   2. `RDB`에서 토큰 상태를 확인 후에 `대기` 혹은 `활성` 토크 상태를 반환한다.


### 3. `대기` -> `활성` 상태로 이동(`TokenScheduler.java`)
   1. 토큰 스케줄러를 통해 30초마다 체크 한다.
   2. `대기`인 토큰을 특정 수 만큼 `활성`상태로 바꾼다.


### 4. `활성` -> `만료` 상태로 이동(`TokenScheduler.java`)
   1. 토큰 스케줄러를 통해 30초마다 체크 한다.
   2. `활성`토큰 중에 만료 시간보다 오래되었으면, `만료`상태로 바꾼다.


### 5. 결제 완료(`활성` -> `토큰 삭제`)
   1. `결제완료`가 되었으면, 더 이상 토큰이 필요하지 않은 상태이다.
   2. 따라서, `활성`상태인 토큰을 삭제한다.


> 위와 같은 로직으로 토큰 상태를 관리하고 있었습니다.

---

## 2. 새로운 방식(Redis로 이관)
- Database를 사용할때는 직접 순번을 계산해서 활성화 시키거나, 등수를 매겨야 했습니다.
- 그런데 Database를 연결하고 순번을 직접 계산하게 된다면 시간적으로, 많은 시간이 소요되는 불편함이 있습니다.
- 따라서 앞으로는 Redis Sorted Set 자료형을 이용하여 순번을 자동으로 계산하고, 대기열을 관리할 수 있도록 구현합니다.

### 1. 대기열 토큰 생성(`POST /api/v1/queue/tokens`)
   1. 사용자가 대기열 토큰 생성 요청을 보낸다.
   2. `Redis`에서 활성화 된 토큰수를 확인 후에 `대기` 혹은 `활성`토큰 발급한다.

**변경 사항** 
- Redis의 Sorted Set 자료형을 이용해서 `대기` 혹은 `활성` 토큰을 발급하도록 수정했습니다.
- activeToken의 개수를 파악하기 위해 O(n)의 성능과 waitingToken의 개수를 파악하기 위해 O(1)의 성능의 쿼리로 수정되었습니다.
- In-memory 기반으로 수행 되기에 빠른 읽기/쓰기 로 작업의 성능 향상이 기대됩니다.
- 또한 Active Token에 있어서 10분뒤 자동 삭제(TTL 설정) 되도록 하여 관리 측면에서 더욱 효율적으로 동작합니다.


### 2. 대기열 토큰 상태 조회(`GET /api/v1/queue/status`)
   1. 사용자가 현재 자신의 토큰 상태 조회 요청을 보낸다.
   2. `Redis`에서 `활성` 상태의 토큰을 조회한다.
      1. 만약 존재한다면, `활성`상태의 토큰을 반환한다.
      2. 존재 하지 않는다면, `대기` 상태의 토큰을 조회한다
   3. 2에서 조회되지 않는다면, 없는 토큰을 조회하려는 행위로 간주하여 에러를 반환한다.

**변경 사항**
- Queue 테이블에서 `활성`, `대기` 토큰을 관리했으나, 둘을 다른 자료형으로 관리합니다.
- `활성` 상태의 토큰을 먼저 조회하고 존재하는지 확인하고(String), `대기` 상태의 토큰을 조회합니다.(Sorted Set)
- 활성 상태에서 조회하더라도 O(n)의 성능을 기대하며, `대기`일때는 O(1)의 성능으로 탐색하는 것을 기대합니다.
- 실제로 활성 상태는 200이하 이므로, O(200)으로 매우 빠르게 동작할 수 있습니다.


### 3. `대기` -> `활성` / `활성` -> `만료` 상태로 이동(`TokenScheduler.java`)
   1. `활성` -> `만료`는 TTL로 자동으로 관리되어 더 이상 관리가 필요 없습니다.
   2. `대기` -> `활성`은 토큰 스케줄러를 통해 10초마다 체크합니다.
      1. 활성 토큰의 개수를 파악합니다.
      2. 활성 토큰의 개수가 200개 보다 적다면, 200개에 맞추도록 `대기`토큰 삭제하고 `활성`토큰을 저장합니다.

**변경 사항**
- `활성` -> `만료`의 스케줄러가 필요하지 않습니다.(TTL을 통해 자동 관리 되기 때문)

### 4. 결제 완료(`활성` -> `토큰 삭제`)
   1. 이전 로직과 동일하게 결제가 완료되었으므로, `활성`상태인 토큰을 삭제한다.